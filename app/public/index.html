<!doctype html>
<meta charset="UTF-8">
<meta name=viewport content="width=device-width, initial-scale=1">

<title>Voting Room</title>
<link rel="stylesheet" href="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css">
<style>
  .roomies {
    list-style-type : none;
    padding         : 0;
  }

  .roomies li {
    display      : inline;
    margin-right : 20px;
    padding      : 5px;
  }

  .voted {
    background-color : palegreen;
  }

  .result-area table {
    margin-left  : auto;
    margin-right : auto;
  }

  .num {
    text-align  : right;
    font-family : "Courier New", Courier, monospace;
  }

</style>

<div data-role="page">
  <div data-role="header"><h1>Vote</h1></div>
  <div role="main" class="ui-content">
    <div class="room-area">
      <ul class="roomies"></ul>
    </div>
    <div class="vote-area">
      <input id="vote-input" type="text" name="num" placeholder="Enter a number...">
      <button id="vote-button">Vote Now!</button>
    </div>
    <div class="result-area">
    </div>
  </div>
  <div data-role="footer">
    <div class="ui-grid-a">
      <div class="ui-block-a" style="text-align: right; padding: 20px"><strong>You are:</strong></div>
      <div class="ui-block-b"><input id="name-input" type="text" name="name" placeholder="Anon"></div>
    </div>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
<script src="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>

<script>

var socket = io();

var
nameInput = $('#name-input'),
voteInput = $('#vote-input'),
name;

if (localStorage.getItem('name')) {
  name = localStorage.getItem('name');
} else {
  name = 'Anon';
}

nameInput.val(name);

nameInput.on('tap', function () {
  $(this).select();
});

socket.on('enter room', function (users) {
  $.each(users, function (id, name) {
    if (!$('.roomies li[data-id="' + id + '"]').length) {
      $('.roomies').append($('<li>').text(name).attr('data-id', id));
    }
  });
});
socket.emit('enter room', name);

socket.on('name change', function (data) {
  var existingUser = $('.roomies li[data-id="' + data.id + '"]');
  if (existingUser.length) {
    existingUser.text(data.name);
  } else {
    $('.roomies').append($('<li>').text(data.name).attr('data-id', data.id));
  }
});
nameInput.change(function () {
  var newName = $(this).val().trim();
  localStorage.setItem('name', newName);
  socket.emit('name change', newName);
});

socket.on('user left', function (id) {
  $('.roomies li[data-id="' + id + '"]').remove();
});

socket.on('vote', function (data) {
  var existingUser = $('.roomies li[data-id="' + data.id + '"]');
  if (existingUser.length) {
    existingUser.addClass('voted');
  } else {
    // shouldn't happen:
    $('.roomies').append($('<li>').text(data.name).attr('data-id', data.id).addClass('voted'));
  }
});
$('#vote-button').on('tap', function (e) {
  var vote = $('#vote-input').val();
  if (!$.isNumeric(vote)) {
    alert('Enter a number.');
    return;
  }
  socket.emit('vote', vote);
  $('.vote-area').remove();
  $('.result-area').text('You voted ' + vote);
});


socket.on('results', function (data) {
  var html = '<table data-role="table" class="ui-responsive"><thead><tr><th>Person</th><th>Vote</th></tr></thead><tbody>';
  var sum = 0;
  $.each(data.users, function (k, v) {
    vote = data.votes[k];
    html += '<tr><td>' + v + '</td><td class="num">' + vote + '</td></tr>';
    sum += parseFloat(vote);
  });
  html += '<tfoot><tr><th>Total</th><th class="num">' + sum + '</th></tr>';
  html += '<tr><th>Average</th><th class="num">' + (sum / Object.keys(data.users).length).toFixed(2) + '</th></tr></tfoot>';
  html += '</tbody></table>';
  html += '<button id="again-button">Again!</button>';
  $('.room-area').remove();
  $('.result-area').html(html);
  $('#again-button').on('tap', function (e) {
    location.reload();
  });

});
</script>